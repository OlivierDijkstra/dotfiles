#!/bin/bash
# Restic full system backup script for NAS
# Run with sudo for full system backup

set -e

# Configuration
export RESTIC_REPOSITORY="/mnt/nasigoreng/backups/restic"
export RESTIC_PASSWORD_FILE="/root/.config/restic/password"

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root for full system backup"
    echo "Usage: sudo $0"
    exit 1
fi

# Check if NAS is mounted
if ! mountpoint -q /mnt/nasigoreng; then
    echo "Error: NAS not mounted at /mnt/nasigoreng"
    exit 1
fi

# Check password file exists
if [[ ! -f "$RESTIC_PASSWORD_FILE" ]]; then
    echo "Error: Password file not found at $RESTIC_PASSWORD_FILE"
    echo "Create it with: sudo mkdir -p /root/.config/restic && sudo tee /root/.config/restic/password && sudo chmod 600 /root/.config/restic/password"
    exit 1
fi

# Export package list
pacman -Qqe > /tmp/pkglist.txt
pacman -Qqm > /tmp/pkglist-aur.txt

echo "Starting full system backup..."

restic backup \
    / \
    --exclude='/dev' \
    --exclude='/proc' \
    --exclude='/sys' \
    --exclude='/tmp' \
    --exclude='/run' \
    --exclude='/mnt' \
    --exclude='/media' \
    --exclude='/lost+found' \
    --exclude='/var/tmp' \
    --exclude='/var/cache' \
    --exclude='/var/log' \
    --exclude='/var/lib/docker' \
    --exclude='/var/lib/containerd' \
    --exclude='/swapfile' \
    --exclude='/home/*/.cache' \
    --exclude='/home/*/.local/share/Trash' \
    --exclude='/home/*/.local/share/Steam' \
    --exclude='/home/*/.mozilla/firefox/*/cache*' \
    --exclude='*.pyc' \
    --exclude='__pycache__' \
    --exclude='node_modules' \
    --exclude='.npm' \
    --exclude='.cargo/registry'

echo "Pruning old backups..."

restic forget \
    --keep-daily 14 \
    --prune

echo "Backup completed successfully"
